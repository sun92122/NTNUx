name: Weekly Crawl and Push TSV

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 9 é»è§¸ç™¼ï¼ˆè‡ºç£æ™‚é–“ï¼‰
    - cron: "0 1 * * 1"
  workflow_dispatch:
    inputs:
      year:
        description: "å­¸å¹´ï¼ˆæ°‘åœ‹å¹´ï¼‰"
        required: false
        default: "114"
      term:
        description: "å­¸æœŸï¼ˆ1=ä¸Šå­¸æœŸ, 2=ä¸‹å­¸æœŸ, 3=æš‘æœŸï¼‰"
        required: false
        default: "1"

jobs:
  crawl-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Run crawler
        working-directory: backend
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          echo "ğŸ“¥ æŠ“å– ${YEAR}-${TERM} èª²ç¨‹è³‡æ–™"
          uv run main.py --year $YEAR --term $TERM

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Commit and push original data
        working-directory: backend
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          git add original_data/
          git commit -m "ğŸ“¦ æ›´æ–°åŸå§‹èª²ç¨‹è³‡æ–™ ${YEAR}-${TERM}" || echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤"
          git push origin main
          echo "âœ… åŸå§‹èª²ç¨‹è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€åˆ° main åˆ†æ”¯"

      - name: Commit and push frontend data
        working-directory: frontend
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          git add public/data/
          git commit -m "ğŸ“¦ æ›´æ–°å‰ç«¯èª²ç¨‹è³‡æ–™ ${YEAR}-${TERM}" || echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤"
          git push origin main
          echo "âœ… å‰ç«¯èª²ç¨‹è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€åˆ° main åˆ†æ”¯"

      - name: Commit and push NTNUx repo
        run: |
          YEAR=${{ github.event.inputs.year || '114' }}
          TERM=${{ github.event.inputs.term || '1' }}
          git add .
          git commit -m "ğŸ“¦ æ¯é€±è‡ªå‹•æ›´æ–°èª²ç¨‹è³‡æ–™ ${YEAR}-${TERM}" || echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤"
          git push origin main
          echo "âœ… NTNUx repo å·²æ›´æ–°ä¸¦æ¨é€åˆ° main åˆ†æ”¯"

      - name: Notify success
        run: echo "ğŸ‰ æ¯é€±èª²ç¨‹è³‡æ–™æ›´æ–°æˆåŠŸï¼"
